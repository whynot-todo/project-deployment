<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <title>每日一笑</title>
    <style>
        .img {
            width: 100%;
            border-radius: 5px;
        }

        article {
            margin: 20px 0 10px 0;
            padding: 10px;
            border-left: 6px solid #dddfe4;
            background-color: #eef0f4;
        }

        button {
            display: block;
            width: 100%;
            border: none;
            background-color: blue;
            color: #fff;
            padding: 10px 10px;
            outline: none;
            border-radius: 2px;
        }

        #top-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #fff;
            background-position: center center;
            background-image: url(https://g.csdnimg.cn/side-toolbar/3.4/images/fanhuidingbucopy.png);
            background-repeat: no-repeat;
            background-size: 30% 30%;
        }

        #popup {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, .5);
        }

        .loading {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border-radius: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            text-align: center;
            line-height: 100px;
            transform: translate(-50%, -50%);

        }
    </style>
    <script type="module">
        $(() => {
            const $btn = $("#btn")
            const url = "https://bird.ioliu.cn/joke/rand"
            const topBtnEle = document.getElementById("top-btn")
            function throttle(func, delay) {
                let run = true
                return function () {
                    if (!run) return
                    run = false
                    setTimeout(() => {
                        func.apply(this, arguments)
                        run = true
                    }, delay)
                }
            }

            const fetchJoke = () => {
                isShowLoading(true)
                try {
                    $.getJSON(url, async (res) => {
                        let _html = ""
                        const { data } = res
                        if (JSON.stringify(data) == "{}") {
                            _html = `<article>今日笑话已看完</article>`
                        } else {
                            _html = data.reduce((_pre, _cur) => {
                                const { content, url, hashId } = _cur
                                return _pre + `
                            <section>
                                <article>${content}</article>
                                <img class="img" src="${url}" alt="${hashId}">
                            </section>
                        `
                            }, "")
                        }
                        $("#content").html(_html)
                        // await isAllImgLoad()
                        isShowLoading(false)
                    })
                } catch (error) {
                    console.log(error)
                    isShowLoading(false)
                }
            }

            const isShowTopBtn = () => {
                // 根据距离来展示回到顶部按钮
                const distance = 300
                let scrollHeight = document.documentElement.scrollTop || document.body.scrollTop
                if (scrollHeight >= distance) topBtnEle.style.display = "block"
                else topBtnEle.style.display = "none"

            }

            const toTop = () => window.scrollTo({
                top: 0,
                behavior: "smooth"
            })

            const isShowLoading = flag => {
                const $popup = $("#popup")
                const $body = $("body")
                if (flag) {
                    // 单例模式，如果弹窗存在，就不创建了
                    if($.isEmptyObject($popup)) return
                    const _html = `<section id="popup">
                                        <div class="loading">loading...</div>
                                    </section>`
                    $body.append(_html)
                    $body.css("overflow","hidden") // 弹框期间禁止滑动
                } else {
                    $("#popup").remove()
                    $body.css("overflow","visible")
                }
            }

            const isAllImgLoad = async() => {
                // 判断当前的页面的所有的图片是否加载完毕
                const _all = []
                $.each($("img"),(_index,_item) => {
                    const _promise = new Promise((resolve,reject) => {
                        _item.onload = () => {
                            console.log(`第${_index + 1}张图片加载完毕~~`)
                            resolve(true)
                        }
                    })
                    _all.push(_promise)
                })
                const _promise = Promise.all(_all)
                await _promise
            }

            const init = () => {
                fetchJoke()
                // 增加监听事件
                window.onscroll = throttle(isShowTopBtn, 100)
                topBtnEle.onclick = () => toTop()
            }

            init()
            $btn.click(() => {
                fetchJoke()
                toTop()
            })
        })
    </script>
</head>

<body>
    <h1>笑一笑十年少</h1>
    <div id="content"></div>
    <button id="btn">刷新</button>
    <!-- 回到顶部按钮 -->
    <div id="top-btn"></div>
</body>

</html>